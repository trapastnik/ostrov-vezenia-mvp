<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IKEA-39 –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ ‚Äî –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }

/* Header */
.header { background: #003399; color: white; padding: 12px 0; position: sticky; top: 0; z-index: 100; }
.header-inner { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
.logo { font-size: 22px; font-weight: 700; letter-spacing: 1px; }
.logo span { color: #ffcc00; }
.cart-btn { background: #ffcc00; color: #003399; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px; }
.cart-btn:hover { background: #ffd633; }
.cart-count { background: #003399; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; }

/* Setup banner */
.setup-banner { background: #fff3cd; border-bottom: 1px solid #ffc107; padding: 10px 20px; }
.setup-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.setup-inner label { font-size: 13px; font-weight: 500; color: #856404; }
.setup-inner input { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; font-size: 13px; width: 280px; }
.setup-inner button { background: #856404; color: white; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
.setup-status { font-size: 12px; color: #155724; font-weight: 500; }

/* Pages */
.page { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
.page.active { display: block; }

/* Catalog */
.catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-top: 20px; }
.product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
.product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
.product-img { height: 180px; background: #e8e8e8; display: flex; align-items: center; justify-content: center; font-size: 48px; }
.product-info { padding: 16px; }
.product-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.product-desc { font-size: 13px; color: #666; margin-bottom: 12px; }
.product-meta { display: flex; justify-content: space-between; align-items: center; }
.product-price { font-size: 18px; font-weight: 700; color: #003399; }
.product-weight { font-size: 12px; color: #999; }
.add-btn { background: #003399; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; width: 100%; margin-top: 12px; }
.add-btn:hover { background: #0044cc; }
.add-btn.added { background: #28a745; }

/* Cart */
.cart-items { margin-top: 20px; }
.cart-item { background: white; border-radius: 10px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
.cart-item-emoji { font-size: 36px; width: 60px; text-align: center; }
.cart-item-info { flex: 1; }
.cart-item-name { font-weight: 600; font-size: 15px; }
.cart-item-price { color: #003399; font-weight: 600; margin-top: 2px; }
.cart-item-qty { display: flex; align-items: center; gap: 8px; }
.qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
.qty-btn:hover { background: #f0f0f0; }
.cart-item-remove { color: #dc3545; cursor: pointer; font-size: 13px; border: none; background: none; }
.cart-summary { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; }
.cart-total { display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.checkout-btn { background: #ffcc00; color: #003399; border: none; padding: 14px 32px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%; }
.checkout-btn:hover { background: #ffd633; }
.empty-cart { text-align: center; padding: 60px 20px; color: #999; }

/* Checkout */
.checkout-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; margin-top: 20px; }
@media (max-width: 800px) { .checkout-grid { grid-template-columns: 1fr; } }
.checkout-section { background: white; border-radius: 10px; padding: 20px; margin-bottom: 16px; }
.checkout-section h3 { font-size: 16px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 13px; font-weight: 500; color: #555; margin-bottom: 4px; }
.form-group input { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
.form-group input:focus { outline: none; border-color: #003399; box-shadow: 0 0 0 3px rgba(0,51,153,0.1); }

.delivery-calc { background: #f0f7ff; border-radius: 8px; padding: 16px; margin-top: 12px; }
.delivery-calc.loading { opacity: 0.6; }
.delivery-calc.error { background: #fff0f0; }
.delivery-cost { font-size: 15px; font-weight: 600; color: #003399; }
.delivery-days { font-size: 13px; color: #666; margin-top: 4px; }
.delivery-breakdown { font-size: 13px; color: #555; margin-top: 8px; }
.delivery-breakdown div { display: flex; justify-content: space-between; padding: 2px 0; }

.order-summary { position: sticky; top: 80px; }
.order-summary .summary-item { display: flex; justify-content: space-between; font-size: 14px; padding: 6px 0; }
.order-summary .summary-total { display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; padding: 12px 0 0; border-top: 2px solid #eee; margin-top: 8px; }
.place-order-btn { background: #28a745; color: white; border: none; padding: 14px 32px; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 16px; }
.place-order-btn:hover { background: #218838; }
.place-order-btn:disabled { background: #ccc; cursor: not-allowed; }

/* Order success / tracking */
.success-page { text-align: center; padding: 40px 20px; }
.success-icon { font-size: 64px; margin-bottom: 16px; }
.success-title { font-size: 24px; font-weight: 700; color: #28a745; margin-bottom: 8px; }
.success-subtitle { font-size: 15px; color: #666; margin-bottom: 24px; }
.order-id-box { background: #f0f7ff; border-radius: 8px; padding: 16px; display: inline-block; margin-bottom: 24px; }
.order-id-box code { font-size: 14px; color: #003399; font-weight: 600; }

.tracking-card { background: white; border-radius: 10px; padding: 24px; max-width: 600px; margin: 20px auto; text-align: left; }
.tracking-status { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.tracking-track { font-size: 13px; color: #666; margin-bottom: 20px; }
.timeline { position: relative; padding-left: 24px; }
.timeline::before { content: ''; position: absolute; left: 7px; top: 4px; bottom: 4px; width: 2px; background: #ddd; }
.timeline-item { position: relative; padding-bottom: 20px; }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: #003399; border: 2px solid white; box-shadow: 0 0 0 2px #003399; }
.timeline-item:not(:first-child) .timeline-dot { background: #ddd; box-shadow: 0 0 0 2px #ddd; }
.timeline-status { font-size: 14px; font-weight: 600; }
.timeline-comment { font-size: 13px; color: #666; }
.timeline-date { font-size: 12px; color: #999; margin-top: 2px; }

.back-link { color: #003399; text-decoration: none; font-size: 14px; cursor: pointer; }
.back-link:hover { text-decoration: underline; }

/* Notifications */
.toast { position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.error { background: #dc3545; }

.status-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }

.limit-hint { font-size: 12px; color: #856404; background: #fff3cd; padding: 8px 12px; border-radius: 6px; margin-top: 12px; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-inner">
    <div class="logo">IKEA<span>-39</span> –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥</div>
    <div style="display:flex;align-items:center;gap:16px;">
      <a onclick="showPage('catalog')" class="back-link" style="color:white">–ö–∞—Ç–∞–ª–æ–≥</a>
      <a onclick="showPage('my-orders')" class="back-link" style="color:white">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a>
      <button class="cart-btn" onclick="showPage('cart')">
        üõí –ö–æ—Ä–∑–∏–Ω–∞ <span class="cart-count" id="cartCount">0</span>
      </button>
    </div>
  </div>
</div>

<!-- API Key setup -->
<div class="setup-banner" id="setupBanner">
  <div class="setup-inner">
    <label>üîë API-–∫–ª—é—á –º–∞–≥–∞–∑–∏–Ω–∞:</label>
    <input type="text" id="apiKeyInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API-–∫–ª—é—á –∏–∑ –∞–¥–º–∏–Ω–∫–∏" />
    <button onclick="setApiKey()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <span class="setup-status" id="setupStatus"></span>
  </div>
</div>

<!-- Page: Catalog -->
<div class="page active" id="page-catalog">
  <h2 style="font-size:24px;font-weight:700;">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h2>
  <p style="color:#666;margin-top:4px;">–ú–µ–±–µ–ª—å –∏ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏</p>
  <div class="limit-hint">üì¶ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –¥–æ 200$ (~18 500 ‚ÇΩ) –∏ –¥–æ 30 –∫–≥ –Ω–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ–µ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ)</div>
  <div class="catalog-grid" id="catalogGrid"></div>
</div>

<!-- Page: Cart -->
<div class="page" id="page-cart">
  <a onclick="showPage('catalog')" class="back-link">‚Üê –í –∫–∞—Ç–∞–ª–æ–≥</a>
  <h2 style="font-size:24px;font-weight:700;margin-top:12px;">–ö–æ—Ä–∑–∏–Ω–∞</h2>
  <div id="cartContent"></div>
</div>

<!-- Page: Checkout -->
<div class="page" id="page-checkout">
  <a onclick="showPage('cart')" class="back-link">‚Üê –í –∫–æ—Ä–∑–∏–Ω—É</a>
  <h2 style="font-size:24px;font-weight:700;margin-top:12px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
  <div class="checkout-grid">
    <div>
      <div class="checkout-section">
        <h3>üìã –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h3>
        <div class="form-group">
          <label>–§–ò–û</label>
          <input type="text" id="recipientName" value="–ò–≤–∞–Ω–æ–≤ –ü—ë—Ç—Ä –°–µ—Ä–≥–µ–µ–≤–∏—á" />
        </div>
        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" id="recipientPhone" value="+79261234567" />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="recipientEmail" value="ivanov@test.ru" />
        </div>
        <div class="form-group">
          <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input type="text" id="recipientAddress" value="–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1, –∫–≤. 5" />
        </div>
        <div class="form-group">
          <label>–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å</label>
          <input type="text" id="recipientPostalCode" value="101000" maxlength="6" />
        </div>
      </div>

      <div class="checkout-section">
        <h3>üöö –î–æ—Å—Ç–∞–≤–∫–∞</h3>
        <div id="deliveryCalc">
          <button onclick="calculateDelivery()" class="add-btn" style="margin-top:0">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</button>
        </div>
      </div>
    </div>

    <div>
      <div class="checkout-section order-summary">
        <h3>üì¶ –í–∞—à –∑–∞–∫–∞–∑</h3>
        <div id="checkoutItems"></div>
        <div id="checkoutTotals"></div>
        <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()" disabled>
          –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Page: Success -->
<div class="page" id="page-success">
  <div class="success-page">
    <div class="success-icon">‚úÖ</div>
    <div class="success-title">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</div>
    <div class="success-subtitle">–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</div>
    <div class="order-id-box">
      <div style="font-size:12px;color:#666;margin-bottom:4px;">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</div>
      <code id="successOrderId"></code>
    </div>
    <div id="successDetails" style="max-width:500px;margin:0 auto;"></div>
    <div style="margin-top:24px;">
      <button onclick="trackLastOrder()" class="add-btn" style="width:auto;display:inline-block;margin-right:8px;">–û—Ç—Å–ª–µ–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
      <button onclick="showPage('catalog')" class="add-btn" style="width:auto;display:inline-block;background:#666;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
    </div>
  </div>
</div>

<!-- Page: Tracking -->
<div class="page" id="page-tracking">
  <a onclick="showPage('my-orders')" class="back-link">‚Üê –ö –º–æ–∏–º –∑–∞–∫–∞–∑–∞–º</a>
  <h2 style="font-size:24px;font-weight:700;margin-top:12px;text-align:center;">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
  <div id="trackingContent"></div>
</div>

<!-- Page: My Orders -->
<div class="page" id="page-my-orders">
  <a onclick="showPage('catalog')" class="back-link">‚Üê –í –∫–∞—Ç–∞–ª–æ–≥</a>
  <h2 style="font-size:24px;font-weight:700;margin-top:12px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
  <div id="myOrdersList" style="margin-top:20px;"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const API_BASE = '/api/v1';
let apiKey = localStorage.getItem('shop_api_key') || '';
let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let myOrders = JSON.parse(localStorage.getItem('my_orders') || '[]');
let lastDeliveryCalc = null;
let orderCounter = parseInt(localStorage.getItem('order_counter') || '1000');

const STATUS_LABELS = {
  accepted: '–ü—Ä–∏–Ω—è—Ç',
  awaiting_pickup: '–û–∂–∏–¥–∞–µ—Ç –∑–∞–±–æ—Ä–∞',
  received_warehouse: '–ù–∞ —Å–∫–ª–∞–¥–µ',
  batch_forming: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏',
  customs_presented: '–ù–∞ —Ç–∞–º–æ–∂–Ω–µ',
  customs_cleared: '–¢–∞–º–æ–∂–Ω—è –ø—Ä–æ–π–¥–µ–Ω–∞',
  awaiting_carrier: '–û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏',
  shipped: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω',
  in_transit: '–í –ø—É—Ç–∏',
  delivered: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
  cancelled: '–û—Ç–º–µ–Ω—ë–Ω',
  problem: '–ü—Ä–æ–±–ª–µ–º–∞',
};

const PRODUCTS = [
  { id: 1, sku: 'KLX-7777-W', name: 'KALLAX –°—Ç–µ–ª–ª–∞–∂', desc: '–ë–µ–ª—ã–π, 77√ó77 —Å–º, 4 —Å–µ–∫—Ü–∏–∏', price: 4999, weight: 12000, emoji: 'üóÑÔ∏è' },
  { id: 2, sku: 'MLM-8010-W', name: 'MALM –ö–æ–º–æ–¥', desc: '4 —è—â–∏–∫–∞, –±–µ–ª—ã–π, 80√ó100 —Å–º', price: 8999, weight: 25000, emoji: 'üóÉÔ∏è' },
  { id: 3, sku: 'PNG-0001-B', name: 'PO√ÑNG –ö—Ä–µ—Å–ª–æ', desc: '–ë–µ—Ä—ë–∑–æ–≤—ã–π —à–ø–æ–Ω, –ø–æ–¥—É—à–∫–∞ —Å–µ—Ä–∞—è', price: 6499, weight: 8000, emoji: 'ü™ë' },
  { id: 4, sku: 'LCK-5555-W', name: 'LACK –°—Ç–æ–ª–∏–∫', desc: '–ü—Ä–∏–¥–∏–≤–∞–Ω–Ω—ã–π, –±–µ–ª—ã–π, 55√ó55 —Å–º', price: 999, weight: 3500, emoji: 'ü™µ' },
  { id: 5, sku: 'KLP-0002-G', name: 'KLIPPAN –ß–µ—Ö–æ–ª', desc: '–î–ª—è –¥–∏–≤–∞–Ω–∞, —Ö–ª–æ–ø–æ–∫, —Å–µ—Ä—ã–π', price: 2999, weight: 2000, emoji: 'üõãÔ∏è' },
  { id: 6, sku: 'HMN-7416-W', name: 'HEMNES –ó–µ—Ä–∫–∞–ª–æ', desc: '–ë–µ–ª–∞—è –º–æ—Ä–∏–ª–∫–∞, 74√ó165 —Å–º', price: 3499, weight: 5000, emoji: 'ü™û' },
  { id: 7, sku: 'ALX-3670-W', name: 'ALEX –¢—É–º–±–∞', desc: '–° —è—â–∏–∫–∞–º–∏, –±–µ–ª—ã–π, 36√ó70 —Å–º', price: 5999, weight: 15000, emoji: 'üì¶' },
  { id: 8, sku: 'FJK-0009-G', name: 'FEJKA –†–∞—Å—Ç–µ–Ω–∏–µ', desc: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ, –≤ –≥–æ—Ä—à–∫–µ, 9 —Å–º', price: 499, weight: 500, emoji: 'üåø' },
  { id: 9, sku: 'I365-003-S', name: 'IKEA 365+ –ù–∞–±–æ—Ä', desc: '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è, 3 —à—Ç', price: 799, weight: 1200, emoji: 'üç±' },
  { id: 10, sku: 'RBB-2130-B', name: 'RIBBA –†–∞–º–∫–∞', desc: '–ß—ë—Ä–Ω–∞—è, 21√ó30 —Å–º', price: 399, weight: 800, emoji: 'üñºÔ∏è' },
  { id: 11, sku: 'SKD-5656-W', name: 'SK√ÖDIS –ü–∞–Ω–µ–ª—å', desc: '–ù–∞—Å—Ç–µ–Ω–Ω–∞—è, –±–µ–ª–∞—è, 56√ó56 —Å–º', price: 1299, weight: 2500, emoji: 'üìå' },
  { id: 12, sku: 'SMG-0060-W', name: 'SM√ÖG√ñRA –ü–æ–ª–∫–∞', desc: '–ù–∞—Å—Ç–µ–Ω–Ω–∞—è, –±–µ–ª—ã–π, 60 —Å–º', price: 1799, weight: 3000, emoji: 'üìö' },
];

// --- Init ---
function init() {
  if (apiKey) {
    document.getElementById('apiKeyInput').value = apiKey;
    document.getElementById('setupStatus').textContent = '‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
  }
  renderCatalog();
  updateCartCount();
}

// --- API Key ---
function setApiKey() {
  apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!apiKey) { toast('–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á', true); return; }
  localStorage.setItem('shop_api_key', apiKey);
  document.getElementById('setupStatus').textContent = '‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
  toast('API-–∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

function apiHeaders() {
  return { 'Content-Type': 'application/json', 'X-API-Key': apiKey };
}

// --- Pages ---
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (name === 'cart') renderCart();
  if (name === 'checkout') renderCheckout();
  if (name === 'my-orders') renderMyOrders();
  window.scrollTo(0, 0);
}

// --- Catalog ---
function renderCatalog() {
  const grid = document.getElementById('catalogGrid');
  grid.innerHTML = PRODUCTS.map(p => `
    <div class="product-card">
      <div class="product-img">${p.emoji}</div>
      <div class="product-info">
        <div class="product-name">${p.name}</div>
        <div style="font-size:11px;color:#999;font-family:monospace;margin-bottom:2px;">${p.sku}</div>
        <div class="product-desc">${p.desc}</div>
        <div class="product-meta">
          <div class="product-price">${formatPrice(p.price)}</div>
          <div class="product-weight">${(p.weight / 1000).toFixed(1)} –∫–≥</div>
        </div>
        <button class="add-btn" onclick="addToCart(${p.id})" id="addBtn${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
  `).join('');
}

// --- Cart ---
function addToCart(productId) {
  if (!apiKey) { toast('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á', true); return; }
  const product = PRODUCTS.find(p => p.id === productId);
  const existing = cart.find(c => c.id === productId);
  if (existing) {
    existing.qty++;
  } else {
    cart.push({ ...product, qty: 1 });
  }
  saveCart();
  updateCartCount();
  const btn = document.getElementById('addBtn' + productId);
  btn.textContent = '‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ';
  btn.classList.add('added');
  setTimeout(() => { btn.textContent = '–í –∫–æ—Ä–∑–∏–Ω—É'; btn.classList.remove('added'); }, 1500);
  toast(`${product.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
}

function removeFromCart(productId) {
  cart = cart.filter(c => c.id !== productId);
  saveCart();
  updateCartCount();
  renderCart();
}

function changeQty(productId, delta) {
  const item = cart.find(c => c.id === productId);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) return removeFromCart(productId);
  saveCart();
  updateCartCount();
  renderCart();
}

function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCartCount() {
  document.getElementById('cartCount').textContent = cart.reduce((s, c) => s + c.qty, 0);
}

function cartTotal() { return cart.reduce((s, c) => s + c.price * c.qty, 0); }
function cartWeight() { return cart.reduce((s, c) => s + c.weight * c.qty, 0); }

function renderCart() {
  const content = document.getElementById('cartContent');
  if (cart.length === 0) {
    content.innerHTML = '<div class="empty-cart"><div style="font-size:48px;margin-bottom:16px;">üõí</div><div style="font-size:18px;font-weight:600;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div><div style="margin-top:8px;">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</div><button onclick="showPage(\'catalog\')" class="add-btn" style="width:auto;margin-top:16px;display:inline-block;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</button></div>';
    return;
  }

  const total = cartTotal();
  const weight = cartWeight();
  const overValue = total > 18500;
  const overWeight = weight > 30000;

  content.innerHTML = `
    <div class="cart-items">
      ${cart.map(c => `
        <div class="cart-item">
          <div class="cart-item-emoji">${c.emoji}</div>
          <div class="cart-item-info">
            <div class="cart-item-name">${c.name}</div>
            <div class="cart-item-price">${formatPrice(c.price * c.qty)}</div>
            <div style="font-size:12px;color:#999;">${(c.weight / 1000).toFixed(1)} –∫–≥ √ó ${c.qty}</div>
          </div>
          <div class="cart-item-qty">
            <button class="qty-btn" onclick="changeQty(${c.id}, -1)">‚àí</button>
            <span style="font-weight:600;min-width:20px;text-align:center;">${c.qty}</span>
            <button class="qty-btn" onclick="changeQty(${c.id}, 1)">+</button>
          </div>
          <button class="cart-item-remove" onclick="removeFromCart(${c.id})">‚úï –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `).join('')}
    </div>
    <div class="cart-summary">
      ${overValue ? '<div style="color:#dc3545;font-size:14px;margin-bottom:8px;">‚ö†Ô∏è –°—É–º–º–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 200$ (~18 500 ‚ÇΩ). –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤.</div>' : ''}
      ${overWeight ? '<div style="color:#dc3545;font-size:14px;margin-bottom:8px;">‚ö†Ô∏è –í–µ—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 30 –∫–≥. –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤.</div>' : ''}
      <div class="cart-total">
        <span>–ò—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä—ã:</span>
        <span>${formatPrice(total)}</span>
      </div>
      <div style="font-size:13px;color:#666;margin-bottom:16px;">–í–µ—Å: ${(weight / 1000).toFixed(1)} –∫–≥</div>
      <button class="checkout-btn" onclick="showPage('checkout')" ${overValue || overWeight ? 'disabled style="background:#ccc;cursor:not-allowed;"' : ''}>
        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
      </button>
    </div>
  `;
}

// --- Checkout ---
function renderCheckout() {
  lastDeliveryCalc = null;
  const itemsDiv = document.getElementById('checkoutItems');
  itemsDiv.innerHTML = cart.map(c => `
    <div class="summary-item">
      <span>${c.emoji} ${c.name} √ó ${c.qty}</span>
      <span>${formatPrice(c.price * c.qty)}</span>
    </div>
  `).join('');
  updateCheckoutTotals();

  document.getElementById('deliveryCalc').innerHTML = `
    <button onclick="calculateDelivery()" class="add-btn" style="margin-top:0">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</button>
  `;
  document.getElementById('placeOrderBtn').disabled = true;
}

function updateCheckoutTotals() {
  const totals = document.getElementById('checkoutTotals');
  const goodsTotal = cartTotal();
  let html = `
    <div class="summary-item"><span>–¢–æ–≤–∞—Ä—ã:</span><span>${formatPrice(goodsTotal)}</span></div>
    <div class="summary-item"><span>–í–µ—Å:</span><span>${(cartWeight() / 1000).toFixed(1)} –∫–≥</span></div>
  `;
  if (lastDeliveryCalc) {
    html += `
      <div class="summary-item"><span>–î–æ—Å—Ç–∞–≤–∫–∞ (–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏):</span><span>${formatPrice(lastDeliveryCalc.delivery_cost_kopecks / 100)}</span></div>
      <div class="summary-item"><span>–¢–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ:</span><span>${formatPrice(lastDeliveryCalc.customs_fee_kopecks / 100)}</span></div>
      <div class="summary-total">
        <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
        <span>${formatPrice(goodsTotal + lastDeliveryCalc.total_cost_kopecks / 100)}</span>
      </div>
    `;
  }
  totals.innerHTML = html;
}

async function calculateDelivery() {
  if (!apiKey) { toast('–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á –º–∞–≥–∞–∑–∏–Ω–∞', true); return; }
  const postalCode = document.getElementById('recipientPostalCode').value.trim();
  if (!postalCode || postalCode.length < 5) { toast('–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å', true); return; }

  const calcDiv = document.getElementById('deliveryCalc');
  calcDiv.innerHTML = '<div class="delivery-calc loading">‚è≥ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏...</div>';

  try {
    const resp = await fetch(API_BASE + '/delivery/calculate', {
      method: 'POST',
      headers: apiHeaders(),
      body: JSON.stringify({
        postal_code: postalCode,
        weight_grams: cartWeight(),
        total_amount_kopecks: cartTotal() * 100,
      }),
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || '–û—à–∏–±–∫–∞');

    if (!data.available) {
      calcDiv.innerHTML = `
        <div class="delivery-calc error">
          ‚ùå –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${data.rejection_reason || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞'}
          <button onclick="calculateDelivery()" class="add-btn" style="margin-top:12px;background:#dc3545;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>`;
      document.getElementById('placeOrderBtn').disabled = true;
      return;
    }

    lastDeliveryCalc = data;
    calcDiv.innerHTML = `
      <div class="delivery-calc">
        <div class="delivery-cost">üöö –î–æ—Å—Ç–∞–≤–∫–∞: ${formatPrice(data.delivery_cost_kopecks / 100)}</div>
        <div class="delivery-days">–°—Ä–æ–∫: ${data.delivery_days_min}‚Äì${data.delivery_days_max} —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</div>
        <div class="delivery-breakdown">
          <div><span>–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏:</span><span>${formatPrice(data.delivery_cost_kopecks / 100)}</span></div>
          <div><span>–¢–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ:</span><span>${formatPrice(data.customs_fee_kopecks / 100)}</span></div>
          <div style="font-weight:600;border-top:1px solid #ccd;padding-top:4px;margin-top:4px;"><span>–ò—Ç–æ–≥–æ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫—É:</span><span>${formatPrice(data.total_cost_kopecks / 100)}</span></div>
        </div>
        <button onclick="calculateDelivery()" class="add-btn" style="margin-top:12px;background:#666;">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
      </div>`;
    updateCheckoutTotals();
    document.getElementById('placeOrderBtn').disabled = false;
  } catch (e) {
    calcDiv.innerHTML = `
      <div class="delivery-calc error">
        ‚ùå ${e.message}
        <button onclick="calculateDelivery()" class="add-btn" style="margin-top:12px;background:#dc3545;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      </div>`;
    document.getElementById('placeOrderBtn').disabled = true;
  }
}

async function placeOrder() {
  if (!apiKey) { toast('–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á', true); return; }
  if (!lastDeliveryCalc) { toast('–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É', true); return; }

  const name = document.getElementById('recipientName').value.trim();
  const phone = document.getElementById('recipientPhone').value.trim();
  const email = document.getElementById('recipientEmail').value.trim();
  const address = document.getElementById('recipientAddress').value.trim();
  const postalCode = document.getElementById('recipientPostalCode').value.trim();

  if (!name || !phone || !address || !postalCode) {
    toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', true); return;
  }

  const btn = document.getElementById('placeOrderBtn');
  btn.disabled = true;
  btn.textContent = '–û—Ñ–æ—Ä–º–ª—è–µ–º...';

  orderCounter++;
  localStorage.setItem('order_counter', orderCounter.toString());

  const body = {
    external_order_id: `WEB-${orderCounter}`,
    recipient: { name, phone, email: email || null, address, postal_code: postalCode },
    items: cart.map(c => ({
      name: c.name,
      sku: c.sku,
      quantity: c.qty,
      price_kopecks: c.price * 100,
      weight_grams: c.weight,
    })),
  };

  try {
    const resp = await fetch(API_BASE + '/orders', {
      method: 'POST',
      headers: apiHeaders(),
      body: JSON.stringify(body),
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');

    // Save order locally
    myOrders.unshift({
      id: data.id,
      external_order_id: data.external_order_id,
      status: data.status,
      total: data.total_amount_kopecks + data.delivery_cost_kopecks + data.customs_fee_kopecks,
      created_at: data.created_at,
      recipient_name: data.recipient_name,
    });
    localStorage.setItem('my_orders', JSON.stringify(myOrders));

    // Show success
    document.getElementById('successOrderId').textContent = data.external_order_id + ' (' + data.id.slice(0, 8) + '...)';
    document.getElementById('successDetails').innerHTML = `
      <div style="text-align:left;background:white;border-radius:10px;padding:16px;margin-top:16px;">
        <div class="summary-item"><span>–¢–æ–≤–∞—Ä—ã:</span><span>${formatPrice(data.total_amount_kopecks / 100)}</span></div>
        <div class="summary-item"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span><span>${formatPrice(data.delivery_cost_kopecks / 100)}</span></div>
        <div class="summary-item"><span>–¢–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ:</span><span>${formatPrice(data.customs_fee_kopecks / 100)}</span></div>
        <div class="summary-total"><span>–ò—Ç–æ–≥–æ:</span><span>${formatPrice((data.total_amount_kopecks + data.delivery_cost_kopecks + data.customs_fee_kopecks) / 100)}</span></div>
        <div style="margin-top:12px;font-size:13px;color:#666;">–°—Ç–∞—Ç—É—Å: ${STATUS_LABELS[data.status] || data.status}</div>
      </div>
    `;

    // Clear cart
    cart = [];
    saveCart();
    updateCartCount();
    showPage('success');
  } catch (e) {
    toast(e.message, true);
    btn.disabled = false;
    btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
  }
}

// --- My Orders ---
function renderMyOrders() {
  const list = document.getElementById('myOrdersList');
  if (myOrders.length === 0) {
    list.innerHTML = '<div class="empty-cart"><div style="font-size:48px;margin-bottom:16px;">üìã</div><div style="font-size:18px;font-weight:600;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div><div style="margin-top:8px;">–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</div></div>';
    return;
  }
  list.innerHTML = myOrders.map(o => `
    <div class="cart-item" style="cursor:pointer;" onclick="trackOrder('${o.id}')">
      <div class="cart-item-emoji">üì¶</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${o.external_order_id}</div>
        <div style="font-size:13px;color:#666;">${o.recipient_name}</div>
        <div style="font-size:12px;color:#999;">${new Date(o.created_at).toLocaleString('ru-RU')}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-weight:600;color:#003399;">${formatPrice(o.total / 100)}</div>
        <div class="status-badge" style="margin-top:4px;background:#e8f0fe;color:#003399;">${STATUS_LABELS[o.status] || o.status}</div>
      </div>
      <div style="color:#999;font-size:20px;">‚Ä∫</div>
    </div>
  `).join('');
}

// --- Tracking ---
function trackLastOrder() {
  if (myOrders.length > 0) trackOrder(myOrders[0].id);
}

async function trackOrder(orderId) {
  showPage('tracking');
  const content = document.getElementById('trackingContent');
  content.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

  try {
    const resp = await fetch(API_BASE + '/orders/' + orderId + '/tracking', { headers: apiHeaders() });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || '–û—à–∏–±–∫–∞');

    // Update local status
    const localOrder = myOrders.find(o => o.id === orderId);

    content.innerHTML = `
      <div class="tracking-card">
        <div class="tracking-status">${STATUS_LABELS[data.status] || data.status}</div>
        <div class="tracking-track">${data.track_number ? '–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä: ' + data.track_number : '–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä –µ—â—ë –Ω–µ –ø—Ä–∏—Å–≤–æ–µ–Ω'}</div>
        ${localOrder ? `<div style="font-size:13px;color:#666;margin-bottom:16px;">–ó–∞–∫–∞–∑: ${localOrder.external_order_id}</div>` : ''}
        <h4 style="font-size:14px;font-weight:600;margin-bottom:12px;">–ò—Å—Ç–æ—Ä–∏—è</h4>
        <div class="timeline">
          ${data.history.slice().reverse().map((h, i) => `
            <div class="timeline-item">
              <div class="timeline-dot" ${i > 0 ? 'style="background:#ddd;box-shadow:0 0 0 2px #ddd;"' : ''}></div>
              <div class="timeline-status">${STATUS_LABELS[h.new_status] || h.new_status}</div>
              ${h.comment ? `<div class="timeline-comment">${h.comment}</div>` : ''}
              <div class="timeline-date">${new Date(h.created_at).toLocaleString('ru-RU')}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div style="text-align:center;margin-top:16px;">
        <button onclick="trackOrder('${orderId}')" class="add-btn" style="width:auto;display:inline-block;background:#666;">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    `;

    if (localOrder) {
      localOrder.status = data.status;
      localStorage.setItem('my_orders', JSON.stringify(myOrders));
    }
  } catch (e) {
    content.innerHTML = `<div style="text-align:center;padding:40px;color:#dc3545;">‚ùå ${e.message}</div>`;
  }
}

// --- Helpers ---
function formatPrice(rub) {
  return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(rub);
}

function toast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

// --- Start ---
init();
</script>
</body>
</html>
